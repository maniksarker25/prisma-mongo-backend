// datasource and generator setup
datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ---------------------------
// Enums
// ---------------------------
enum UserRole {
  user
  admin
  superAdmin
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum SubscriptionType {
  Free
  Premium
  Pro
}

enum ConversationType {
  ONE_TO_ONE
  PROJECT
  GROUP
  BOND_LINK
  INSTITUTION
}

// User model
model User {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  profileId         String?   @default("")
  email             String    @unique
  password          String
  passwordChangedAt DateTime?
  role              UserRole
  isBlocked         Boolean   @default(false)
  isActive          Boolean   @default(true)
  verifyCode        Int?
  resetCode         Int?
  isVerified        Boolean   @default(false)
  isResetVerified   Boolean   @default(false)
  codeExpireIn      DateTime?
  appleId           String?
  googleId          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  normalUser NormalUser?
  superAdmin SuperAdmin?
  admin      Admin?

  @@map("users")
}

// NormalUser model
model NormalUser {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  userId        String    @unique @db.ObjectId
  name          String
  email         String    @unique
  phone         String?
  profile_image String?   @default("")
  gender        Gender?
  dateOfBirth   DateTime?
  address       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id])
  messages Message[]
}

// SuperAdmin model
model SuperAdmin {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @unique @db.ObjectId
  name          String
  email         String   @unique
  phone         String?
  profile_image String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("superadmins")
}

// Admin model
model Admin {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @unique @db.ObjectId
  name          String
  email         String   @unique
  phone         String?
  profile_image String?  @default("")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @default(now())

  // Relations 
  user User @relation(fields: [userId], references: [id])
}

// Message model
model Message {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  text           String
  imageUrl       String[]
  msgByUserId    String       @db.ObjectId
  sender         NormalUser   @relation(fields: [msgByUserId], references: [id])
  conversationId String       @db.ObjectId
  conversation   Conversation @relation("ConversationMessages", fields: [conversationId], references: [id])
  seen           Boolean      @default(false)
  createdAt      DateTime     @default(now())

  // Relation for lastMessage (reverse side)
  lastMessageInConversation Conversation[] @relation("LastMessage")
}

// Conversation model
model Conversation {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  participants String[] @db.ObjectId // array of NormalUser IDs (manually managed)

  lastMessageId String?  @db.ObjectId
  lastMessage   Message? @relation("LastMessage", fields: [lastMessageId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  type ConversationType @default(ONE_TO_ONE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[] @relation("ConversationMessages")
}
